<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hello Deer by DAPP</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background: #222; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* Glassmorphism Gallery Overlay */
        .gallery-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            z-index: 11000; display: none; flex-direction: column; align-items: center; justify-content: center; 
        }
        .gallery-card { 
            background: rgba(255, 255, 255, 0.8); padding: 25px; border-radius: 30px; 
            width: 85%; max-width: 380px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center;
        }
        .gallery-img { width: 100%; border-radius: 20px; aspect-ratio: 1/1; object-fit: cover; margin-bottom: 15px; background: #eee; }

        /* Time Scrubber Widget */
        .time-widget {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            z-index: 9000; background: rgba(255,255,255,0.9); padding: 10px 20px;
            border-radius: 50px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 80%; max-width: 300px;
        }
        #time-slider { flex: 1; accent-color: #2d5a27; }

        /* UI Styling Refinements */
        .ui-panel { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); z-index: 9000; background: white; padding: 22px; border-radius: 28px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); width: 88%; max-width: 400px; text-align: center; }
        .btn-report { background: #2d5a27; color: white; border: none; padding: 18px; width: 100%; border-radius: 16px; font-weight: bold; cursor: pointer; }
        .filter-widget { position: absolute; bottom: 120px; right: 15px; z-index: 9001; }
        .filter-btn { background: white; width: 50px; height: 50px; border-radius: 25px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

        .step { display: none; }
        .step.active { display: block; }
        .nav-btn { background: #2d5a27; color: white; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="time-widget">
    <span id="time-label" style="font-weight: 800; font-size: 0.8rem; min-width: 45px;">12:00</span>
    <input type="range" id="time-slider" min="0" max="1439" value="720" oninput="updateTimeFilter()">
</div>

<div id="gallery" class="gallery-overlay">
    <div class="gallery-card">
        <h2 id="gal-title" style="margin-top:0; color:#2d5a27;"></h2>
        <img id="gal-img" class="gallery-img" src="" alt="Loading...">
        <p id="gal-desc" style="color:#555; font-size: 0.9rem; line-height: 1.4;"></p>
        <div style="display:flex; justify-content: space-between; margin-top:20px;">
            <button class="nav-btn" onclick="prevGal()">Prev</button>
            <button class="nav-btn" style="background:#444" onclick="closeGallery()">Close</button>
            <button class="nav-btn" onclick="nextGal()">Next</button>
        </div>
    </div>
</div>

<div id="map"></div>

<div class="ui-panel">
    <div id="main-ui">
        <div style="font-weight:800; color:#2d5a27; font-size:1.4rem;">Hello Deer</div>
        <div id="park-name" style="font-size:0.8rem; color:#666; margin-bottom:12px;">Richmond Park</div>
        <button class="btn-report" onclick="startWizard()">+ Report Sighting</button>
    </div>

    <div id="step-1" class="step">
        <h3>Species?</h3>
        <button class="btn-report" style="margin-bottom:10px; background:#c0392b;" onclick="nextStep(2, 'Red')">Red Deer</button>
        <button class="btn-report" style="background:#2980b9;" onclick="nextStep(2, 'Fallow')">Fallow Deer</button>
        <p onclick="openGallery()" style="text-decoration:underline; font-size:0.8rem; margin-top:10px; cursor:pointer;">Not sure? Open Guide</p>
    </div>

    <div id="step-2" class="step">
        <h3>Verify Sighting</h3>
        <p style="font-size:0.8rem; color:#666;">Are you currently looking at the deer?</p>
        <button class="btn-report" onclick="submitSighting(true)">Yes, Verify Now</button>
        <button class="btn-report" style="background:#999; margin-top:10px;" onclick="submitSighting(false)">I saw them earlier</button>
    </div>
</div>

<script>
    const map = L.map('map', { zoomControl: false, tap: false }).setView([51.442, -0.285], 14);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let redHeat = L.heatLayer([], {radius: 35, blur: 20, minOpacity: 0.5, gradient: {0.4: '#ffd166', 0.7: '#f4a261', 1.0: '#e63946'}}).addTo(map);
    let fallowHeat = L.heatLayer([], {radius: 35, blur: 20, minOpacity: 0.5, gradient: {0.4: '#90e0ef', 0.7: '#00b4d8', 1.0: '#0077b6'}}).addTo(map);

    const galleryData = [
        { t: "Red Stag", d: "Large branched antlers, massive body.", img: "https://images.unsplash.com/photo-1543946207-39bd91e70ca7?w=400" },
        { t: "Red Hind", d: "Female Red deer. No antlers, reddish coat.", img: "https://images.unsplash.com/photo-1608613437502-39bd37536f9a?w=400" },
        { t: "Fallow Buck", d: "Broad, palm-like antlers. Spotted coat.", img: "https://images.unsplash.com/photo-1484406566174-9da000fda645?w=400" },
        { t: "Fallow Doe", d: "Female Fallow. White rump, smaller frame.", img: "https://images.unsplash.com/photo-1518173946687-a4c8a3b778f1?w=400" }
    ];
    let galIdx = 0;

    // Dummy data with Time stamps (0 to 1439 minutes)
    const sightings = [];
    function seedData() {
        for(let i=0; i<150; i++) {
            sightings.push({
                lat: 51.442 + (Math.random()-0.5)*0.06,
                lng: -0.31 + (Math.random()-0.5)*0.08,
                species: Math.random() > 0.5 ? 'Red' : 'Fallow',
                time: Math.floor(Math.random() * 1440) 
            });
        }
    }
    seedData();

    function updateTimeFilter() {
        const val = document.getElementById('time-slider').value;
        const h = Math.floor(val/60).toString().padStart(2,'0');
        const m = (val%60).toString().padStart(2,'0');
        document.getElementById('time-label').innerText = `${h}:${m}`;

        // Show sightings within a 3-hour window of the selected time
        const range = 180; 
        const filtered = sightings.filter(s => Math.abs(s.time - val) < range);
        
        const rPoints = filtered.filter(s => s.species==='Red').map(s => [s.lat, s.lng, 1.0]);
        const fPoints = filtered.filter(s => s.species==='Fallow').map(s => [s.lat, s.lng, 1.0]);
        
        redHeat.setLatLngs(rPoints);
        fallowHeat.setLatLngs(fPoints);
    }

    function openGallery() { document.getElementById('gallery').style.display='flex'; updateGal(); }
    function closeGallery() { document.getElementById('gallery').style.display='none'; }
    function nextGal() { galIdx = (galIdx + 1) % galleryData.length; updateGal(); }
    function prevGal() { galIdx = (galIdx - 1 + galleryData.length) % galleryData.length; updateGal(); }
    function updateGal() {
        document.getElementById('gal-title').innerText = galleryData[galIdx].t;
        document.getElementById('gal-img').src = galleryData[galIdx].img;
        document.getElementById('gal-desc').innerText = galleryData[galIdx].d;
    }

    function startWizard() { document.getElementById('main-ui').style.display='none'; document.getElementById('step-1').classList.add('active'); }
    function nextStep(s, species) { document.querySelectorAll('.step').forEach(d => d.classList.remove('active')); document.getElementById('step-'+s).classList.add('active'); }
    function hideAll() { document.querySelectorAll('.step').forEach(s => s.classList.remove('active')); document.getElementById('main-ui').style.display='block'; }
    function submitSighting(v) { alert(v ? "Verified Sighting Recorded!" : "Sighting Logged."); hideAll(); }

    window.onload = updateTimeFilter;
</script>
</body>
</html>
