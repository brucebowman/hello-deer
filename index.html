<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hello Deer by DAPP</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background: #222; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* UI Hierarchy */
        .leaflet-top.leaflet-right { top: 10px !important; right: 10px !important; }
        .hamburger { position: absolute; top: 15px; left: 15px; z-index: 9999; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; display: flex; flex-direction: column; gap: 4px; }
        .hamburger div { width: 24px; height: 3px; background: #2d5a27; border-radius: 2px; }

        /* Time Panel */
        .time-panel {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            z-index: 9000; background: rgba(255,255,255,0.95); padding: 12px;
            border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); width: 88%; max-width: 380px;
        }
        .time-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        #time-slider { flex: 1; accent-color: #2d5a27; }
        .duration-picker { display: flex; justify-content: space-between; gap: 2px; }
        .dur-btn { background: #eee; border: none; padding: 5px 2px; border-radius: 4px; font-size: 0.6rem; font-weight: bold; cursor: pointer; flex: 1; }
        .dur-btn.active { background: #2d5a27; color: white; }

        /* Species Filter Widget (The Missing Piece) */
        .filter-widget { position: absolute; bottom: 130px; right: 15px; z-index: 9001; }
        .filter-btn { background: white; width: 52px; height: 52px; border-radius: 26px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; font-size: 1.3rem; border: none; }
        .filter-options { position: absolute; bottom: 65px; right: 0; background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: none; width: 190px; }
        .filter-options.show { display: block; }
        .filter-group-label { font-size: 0.65rem; color: #999; margin: 8px 0 4px 0; letter-spacing: 0.5px; }
        .filter-opt { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.8rem; font-weight: bold; cursor: pointer; }

        /* Bottom UI */
        .ui-panel { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); z-index: 9000; background: white; padding: 22px; border-radius: 28px; box-shadow: 0 12px 40px rgba(0,0,0,0.4); width: 88%; max-width: 400px; text-align: center; }
        .btn-report { background: #2d5a27; color: white; border: none; padding: 18px; width: 100%; border-radius: 16px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="hamburger" onclick="toggleMenu()"><div></div><div></div><div></div></div>

<div class="time-panel">
    <div class="time-controls">
        <button id="play-btn" onclick="togglePlay()" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">‚è∏</button>
        <div style="display: flex; flex-direction: column; flex-grow: 1;">
            <span id="time-label" style="font-weight: 800; font-size: 0.9rem;">11:15</span>
            <span id="window-label" style="font-size: 0.6rem; color: #666;">Rolling Window: 3h</span>
        </div>
        <input type="range" id="time-slider" min="0" max="1439" value="675" oninput="manualTimeChange()">
    </div>
    <div class="duration-picker">
        <button class="dur-btn" onclick="setWindow(60)">1h</button>
        <button class="dur-btn" onclick="setWindow(120)">2h</button>
        <button class="dur-btn active" onclick="setWindow(180)">3h</button>
        <button class="dur-btn" onclick="setWindow(360)">6h</button>
        <button class="dur-btn" onclick="setWindow(720)">12h</button>
        <button class="dur-btn" onclick="setWindow(1440)">24h</button>
    </div>
</div>

<div class="filter-widget">
    <div class="filter-options" id="filter-box">
        <div class="filter-group-label">RED DEER</div>
        <label class="filter-opt"><input type="checkbox" checked onchange="updateMap()" id="f-red-m"> <span style="color:#e63946">‚óè</span> Stags</label>
        <label class="filter-opt"><input type="checkbox" checked onchange="updateMap()" id="f-red-f"> <span style="color:#f4a261">‚óè</span> Hinds</label>
        <label class="filter-opt"><input type="checkbox" checked onchange="updateMap()" id="f-red-y"> <span style="color:#ffd166">‚óè</span> Calves</label>
        <div class="filter-group-label">FALLOW DEER</div>
        <label class="filter-opt"><input type="checkbox" checked onchange="updateMap()" id="f-fal-m"> <span style="color:#0077b6">‚óè</span> Bucks</label>
        <label class="filter-opt"><input type="checkbox" checked onchange="updateMap()" id="f-fal-f"> <span style="color:#00b4d8">‚óè</span> Does</label>
        <label class="filter-opt"><input type="checkbox" checked onchange="updateMap()" id="f-fal-y"> <span style="color:#90e0ef">‚óè</span> Fawns</label>
    </div>
    <button class="filter-btn" onclick="document.getElementById('filter-box').classList.toggle('show')">üîç</button>
</div>

<div id="map"></div>

<div class="ui-panel">
    <div style="font-weight:800; color:#2d5a27; font-size:1.3rem;">Hello Deer Prototype</div>
    <div style="display:flex; gap:8px; margin-top:10px;">
        <button style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd; background:#f8f9fa;" onclick="map.flyTo([51.442, -0.285], 14)">üìç Richmond</button>
        <button style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd; background:#f8f9fa;" onclick="map.flyTo([51.413, -0.339], 14)">üìç Bushy</button>
    </div>
</div>

<script>
    const map = L.map('map', { zoomControl: false, tap: false }).setView([51.442, -0.285], 14);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // AMPED UP HEATMAP SETTINGS
    let redHeat = L.heatLayer([], {radius: 45, blur: 15, minOpacity: 0.6, gradient: {0.4: '#ffd166', 0.8: '#f4a261', 1.0: '#e63946'}}).addTo(map);
    let fallowHeat = L.heatLayer([], {radius: 45, blur: 15, minOpacity: 0.6, gradient: {0.4: '#90e0ef', 0.8: '#00b4d8', 1.0: '#0077b6'}}).addTo(map);

    let isPlaying = true;
    let lookbackMinutes = 180;
    const sightings = [];

    // Seed 800 points for massive heatmap visibility
    function seed() {
        const types = ['m', 'f', 'y'];
        for(let i=0; i<800; i++) {
            sightings.push({
                lat: 51.40 + (Math.random() * 0.08),
                lng: -0.36 + (Math.random() * 0.10),
                species: Math.random() > 0.5 ? 'Red' : 'Fallow',
                sex: types[Math.floor(Math.random() * 3)],
                time: Math.floor(Math.random() * 1440) 
            });
        }
    }
    seed();

    function updateMap() {
        const currentT = parseInt(document.getElementById('time-slider').value);
        const h = Math.floor(currentT/60).toString().padStart(2,'0');
        const m = (currentT%60).toString().padStart(2,'0');
        document.getElementById('time-label').innerText = `${h}:${m}`;

        // Get filter states
        const f = {
            rm: document.getElementById('f-red-m').checked, rf: document.getElementById('f-red-f').checked, ry: document.getElementById('f-red-y').checked,
            fm: document.getElementById('f-fal-m').checked, ff: document.getElementById('f-fal-f').checked, fy: document.getElementById('f-fal-y').checked
        };

        const filtered = sightings.filter(s => {
            let start = currentT - lookbackMinutes;
            let inTime = (start < 0) ? (s.time >= (1440 + start) || s.time <= currentT) : (s.time >= start && s.time <= currentT);
            if (!inTime) return false;

            if (s.species === 'Red') {
                return (s.sex === 'm' && f.rm) || (s.sex === 'f' && f.rf) || (s.sex === 'y' && f.ry);
            } else {
                return (s.sex === 'm' && f.fm) || (s.sex === 'f' && f.ff) || (s.sex === 'y' && f.fy);
            }
        });
        
        redHeat.setLatLngs(filtered.filter(s => s.species==='Red').map(s => [s.lat, s.lng, 1.0]));
        fallowHeat.setLatLngs(filtered.filter(s => s.species==='Fallow').map(s => [s.lat, s.lng, 1.0]));
    }

    function loopLogic() {
        if(!isPlaying) return;
        let slider = document.getElementById('time-slider');
        slider.value = (parseInt(slider.value) + 5) % 1440;
        updateMap();
    }

    function setWindow(mins) {
        lookbackMinutes = mins;
        document.getElementById('window-label').innerText = `Rolling Window: ${mins >= 60 ? mins/60 + 'h' : mins + 'm'}`;
        document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        updateMap();
    }

    function togglePlay() { isPlaying = !isPlaying; document.getElementById('play-btn').innerText = isPlaying ? "‚è∏" : "‚ñ∂"; }
    function manualTimeChange() { isPlaying = false; document.getElementById('play-btn').innerText = "‚ñ∂"; updateMap(); }
    
    setInterval(loopLogic, 100); // Faster tick for smoother play
    window.onload = updateMap;
</script>
</body>
</html>
