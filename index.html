<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Hello Deer by DAPP</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <style>
        :root { --primary: #2d5a27; --glass: rgba(255, 255, 255, 0.98); }
        
        /* NUCLEAR OPTION FOR WHITE STRIP: Force absolute layout */
        body, html { 
            margin: 0; padding: 0; width: 100vw; height: 100vh; 
            overflow: hidden !important; background: black; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
        }

        #map { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            z-index: 1; width: 100%; height: 100%;
        }

        /* UI SHELL - Fixed Z-Indices */
        .hamburger { position: absolute; top: 15px; left: 15px; z-index: 9999; background: white; border-radius: 8px; padding: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; }
        .hamburger div { width: 24px; height: 3px; background: var(--primary); border-radius: 2px; margin: 4px 0; }
        
        .side-menu { position: fixed; top: 0; left: -310px; width: 280px; height: 100%; background: #fff; z-index: 10001; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 30px; }
        .side-menu.open { left: 0; }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 10000; display: none; backdrop-filter: blur(4px); }
        .menu-overlay.active { display: block; }

        /* TIME PANEL */
        .time-panel { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); z-index: 9000; background: var(--glass); padding: 15px; border-radius: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); width: 90%; max-width: 400px; }
        .dur-btn { background: #f0f0f0; border: none; padding: 8px; border-radius: 8px; font-size: 0.7rem; font-weight: bold; cursor: pointer; flex: 1; transition: 0.2s; }
        .dur-btn.active { background: var(--primary); color: white; }
        
        /* REPORTING & WIZARD (STRICT FIXED) */
        .ui-panel { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9000; background: white; padding: 25px; border-radius: 32px; box-shadow: 0 15px 50px rgba(0,0,0,0.4); width: 88%; max-width: 420px; text-align: center; }
        .btn-report { background: var(--primary); color: white; border: none; padding: 18px; width: 100%; border-radius: 16px; font-weight: 800; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .step { display: none; }
        .step.active { display: block; }
        .grid-select { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .grid-btn { padding: 18px; border: 2px solid #eee; border-radius: 14px; background: #fff; font-weight: 700; cursor: pointer; }
        .grid-btn:active { background: #f0f0f0; border-color: var(--primary); }

        /* FILTER WIDGET */
        .filter-widget { position: absolute; bottom: 210px; right: 15px; z-index: 9001; }
        .filter-btn { background: white; width: 55px; height: 55px; border-radius: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: none; font-size: 1.4rem; }
        .filter-box { position: absolute; bottom: 70px; right: 0; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; width: 200px; }
        .filter-box.show { display: block; }

        /* GALLERY */
        .gallery-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.85); z-index: 11000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .gallery-card { background: white; padding: 30px; border-radius: 35px; width: 85%; max-width: 380px; text-align: center; }
        .gallery-img { width: 100%; border-radius: 20px; aspect-ratio: 1/1; object-fit: cover; margin-bottom: 15px; background: #eee; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu()"></div>
    <div class="hamburger" onclick="toggleMenu()"><div></div><div></div><div></div></div>

    <div id="side-menu" class="side-menu">
        <h2 style="color:var(--primary); margin-bottom:20px;">Hello Deer</h2>
        <div style="padding:18px 0; border-bottom:1px solid #eee; cursor:pointer;" onclick="openGallery()">üñºÔ∏è Species Gallery</div>
        <div style="padding:18px 0; border-bottom:1px solid #eee; cursor:pointer;" onclick="window.open('https://www.youtube.com/watch?v=acwRCNxqWbA')">üéûÔ∏è Safety Film</div>
        <div style="margin-top:50px; color:#999;" onclick="toggleMenu()">‚úï Close Menu</div>
    </div>

    <div class="time-panel">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
            <button onclick="togglePlay()" id="play-btn" style="border:none; background:none; font-size:1.4rem;">‚è∏</button>
            <div style="flex-grow:1;">
                <span id="time-label" style="font-weight:900; font-size:1.1rem; display:block;">--:--</span>
                <span style="font-size:0.65rem; color:#d9480f; font-weight:bold; letter-spacing: 0.5px;">REPLAYING DATA</span>
            </div>
            <input type="range" id="time-slider" min="0" max="180" value="180" oninput="manualScrub()" style="flex:1.5; accent-color: var(--primary);">
        </div>
        <div style="display:flex; gap:5px;">
            <button class="dur-btn" onclick="setWindow(60)">1h</button>
            <button class="dur-btn active" onclick="setWindow(180)">3h</button>
            <button class="dur-btn" onclick="setWindow(360)">6h</button>
            <button class="dur-btn" onclick="setWindow(720)">12h</button>
        </div>
    </div>

    <div id="gallery" class="gallery-overlay">
        <div class="gallery-card">
            <h2 id="gal-title" style="margin-top:0; color:var(--primary);"></h2>
            <img id="gal-img" class="gallery-img" src="">
            <p id="gal-desc" style="color:#666; font-size:0.9rem; height:40px;"></p>
            <div style="display:flex; justify-content:space-between; gap:10px; margin-top:20px;">
                <button class="dur-btn" onclick="prevGal()">Prev</button>
                <button class="dur-btn" style="background:var(--primary); color:white;" onclick="closeGallery()">Close</button>
                <button class="dur-btn" onclick="nextGal()">Next</button>
            </div>
        </div>
    </div>

    <div class="filter-widget">
        <div class="filter-box" id="filter-box">
            <div style="font-size:0.6rem; font-weight:900; color:#aaa; margin-bottom:8px;">FILTERS</div>
            <label style="display:block; font-size:0.85rem; padding:4px 0;"><input type="checkbox" checked onchange="updateMap()" id="f-red"> Red Deer</label>
            <label style="display:block; font-size:0.85rem; padding:4px 0;"><input type="checkbox" checked onchange="updateMap()" id="f-fal"> Fallow Deer</label>
        </div>
        <button class="filter-btn" onclick="document.getElementById('filter-box').classList.toggle('show')">üîç</button>
    </div>

    <div id="map"></div>

    <div class="ui-panel">
        <div id="main-ui">
            <div id="park-display" style="font-weight:900; color:var(--primary); font-size:1.2rem; margin-bottom:5px;">Richmond Park</div>
            <div style="font-size:0.75rem; color:#888; margin-bottom:15px;">Live Sightings Data</div>
            <button class="btn-report" onclick="startWizard()">+ REPORT A SIGHTING</button>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="grid-btn" style="flex:1; padding:10px;" onclick="gotoPark('Richmond')">üìç Richmond</button>
                <button class="grid-btn" style="flex:1; padding:10px;" onclick="gotoPark('Bushy')">üìç Bushy</button>
            </div>
        </div>

        <div id="wiz-1" class="step">
            <h3 style="margin:0;">Species?</h3>
            <div class="grid-select">
                <button class="grid-btn" onclick="wizStep(1, 2, 'Red')">Red Deer</button>
                <button class="grid-btn" onclick="wizStep(1, 2, 'Fallow')">Fallow Deer</button>
            </div>
            <p onclick="hideAll()" style="color:#999; margin-top:20px; cursor:pointer; font-weight:bold;">Cancel</p>
        </div>

        <div id="wiz-2" class="step">
            <h3 style="margin:0;">Type?</h3>
            <div class="grid-select" id="cat-options"></div>
            <p onclick="wizStep(2, 1)" style="color:#999; margin-top:20px; cursor:pointer; font-weight:bold;">Back</p>
        </div>

        <div id="wiz-3" class="step">
            <h3 style="margin:0;">Verify Now?</h3>
            <button class="btn-report" onclick="submitSighting(true)">Looking at them now</button>
            <button class="btn-report" style="background:#888" onclick="submitSighting(false)">Saw them earlier</button>
            <p onclick="wizStep(3, 2)" style="color:#999; margin-top:20px; cursor:pointer; font-weight:bold;">Back</p>
        </div>
    </div>
</div>

<script>
    const map = L.map('map', { zoomControl: false, tap: false, attributionControl: false }).setView([51.442, -0.285], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let redHeat = L.heatLayer([], {radius: 35, blur: 20}).addTo(map);
    let fallowHeat = L.heatLayer([], {radius: 35, blur: 20}).addTo(map);

    let isPlaying = true, lookbackMins = 180, sightings = [], curRep = {};

    const galData = [
        { t: "Red Stag", d: "Large branched antlers. King of the park.", img: "https://images.unsplash.com/photo-1543946207-39bd91e70ca7?w=400" },
        { t: "Red Hind", d: "Female Red deer. No antlers. Very alert.", img: "https://images.unsplash.com/photo-1608613437502-39bd37536f9a?w=400" },
        { t: "Red Calf", d: "Young Red deer. Often spotted in high grass.", img: "https://images.unsplash.com/photo-1540306346245-094186407f14?w=400" },
        { t: "Fallow Buck", d: "Male Fallow. Broad, palm-like antlers.", img: "https://images.unsplash.com/photo-1484406566174-9da000fda645?w=400" },
        { t: "Fallow Doe", d: "Spotted coat. White rump markings.", img: "https://images.unsplash.com/photo-1518173946687-a4c8a3b778f1?w=400" },
        { t: "Fallow Fawn", d: "Very small, heavily spotted.", img: "https://images.unsplash.com/photo-1506450681928-8103e7448e65?w=400" }
    ];
    let galIdx = 0;

    // PRECISE POLYGONS FOR CLIPPING
    const RICHMOND_P = [[51.458,-0.297],[51.455,-0.279],[51.442,-0.272],[51.428,-0.285],[51.432,-0.306],[51.445,-0.312]];
    const BUSHY_P = [[51.420,-0.342],[51.418,-0.325],[51.408,-0.322],[51.405,-0.345]];

    function isInside(p, vs) {
        let x = p[0], y = p[1], inside = false;
        for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
            let xi = vs[i][0], yi = vs[i][1], xj = vs[j][0], yj = vs[j][1];
            if (((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) inside = !inside;
        }
        return inside;
    }

    function seed() {
        while(sightings.length < 600) {
            let poly = Math.random() > 0.6 ? RICHMOND_P : BUSHY_P;
            let lat = 51.40 + (Math.random() * 0.06), lng = -0.35 + (Math.random() * 0.08);
            if (isInside([lat, lng], poly)) {
                sightings.push({ lat, lng, species: Math.random() > 0.5 ? 'Red' : 'Fallow', sex: ['m','f','y'][Math.floor(Math.random()*3)], time: Math.floor(Math.random() * 1440) });
            }
        }
    }
    seed();

    function updateMap() {
        const pbTime = ( (new Date().getHours()*60 + new Date().getMinutes()) - lookbackMins + parseInt(document.getElementById('time-slider').value) + 1440) % 1440;
        document.getElementById('time-label').innerText = `${Math.floor(pbTime/60).toString().padStart(2,'0')}:${(pbTime%60).toString().padStart(2,'0')}`;

        const showRed = document.getElementById('f-red').checked, showFal = document.getElementById('f-fal').checked;

        const filtered = sightings.filter(s => {
            let diff = (pbTime - s.time + 1440) % 1440;
            return diff >= 0 && diff <= lookbackMins;
        }).map(s => [s.lat, s.lng, 1.0 - (((pbTime - s.time + 1440) % 1440) / lookbackMins)]);

        redHeat.setLatLngs(showRed ? filtered.filter((_,i) => sightings[i].species==='Red') : []);
        fallowHeat.setLatLngs(showFal ? filtered.filter((_,i) => sightings[i].species==='Fallow') : []);
    }

    // WIZARD CORE
    function startWizard() { document.getElementById('main-ui').style.display='none'; document.getElementById('wiz-1').classList.add('active'); }
    function wizStep(cur, next, data) {
        if(data && cur === 1) {
            curRep.species = data;
            const labels = data === 'Red' ? ['Stag','Hind','Calf'] : ['Buck','Doe','Fawn'];
            const keys = ['m','f','y'];
            document.getElementById('cat-options').innerHTML = labels.map((l, i) => `<button class="grid-btn" onclick="wizStep(2,3,'${keys[i]}')">${l}</button>`).join('');
        }
        if(data && cur === 2) curRep.sex = data;
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('wiz-'+next).classList.add('active');
    }
    function submitSighting(v) { alert(`Successfully Logged: ${curRep.species} ${curRep.sex}`); hideAll(); }
    function hideAll() { document.querySelectorAll('.step').forEach(s => s.classList.remove('active')); document.getElementById('main-ui').style.display='block'; }

    // CONTROLS
    function togglePlay() { isPlaying = !isPlaying; document.getElementById('play-btn').innerText = isPlaying ? "‚è∏" : "‚ñ∂"; }
    function manualScrub() { isPlaying = false; document.getElementById('play-btn').innerText = "‚ñ∂"; updateMap(); }
    function setWindow(m) { lookbackMins = m; document.getElementById('time-slider').max = m; document.getElementById('time-slider').value = m; updateMap(); }
    function gotoPark(n) { map.flyTo(n==='Richmond'?[51.442,-0.285]:[51.413,-0.339], 14); document.getElementById('park-display').innerText=n+" Park"; }
    function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); document.getElementById('menu-overlay').classList.toggle('active'); }
    function openGallery() { document.getElementById('gallery').style.display='flex'; updateGal(); }
    function closeGallery() { document.getElementById('gallery').style.display='none'; }
    function prevGal() { galIdx = (galIdx - 1 + 6) % 6; updateGal(); }
    function nextGal() { galIdx = (galIdx + 1) % 6; updateGal(); }
    function updateGal() { document.getElementById('gal-title').innerText = galData[galIdx].t; document.getElementById('gal-img').src = galData[galIdx].img; document.getElementById('gal-desc').innerText = galData[galIdx].d; }

    setInterval(() => { if(isPlaying) { let s = document.getElementById('time-slider'); s.value = (parseInt(s.value)+1) % lookbackMins; updateMap(); } }, 100);
    window.onload = updateMap;
</script>
</body>
</html>
